<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>æ™ºèƒ½ä½œä¸šåˆ›å»ºç³»ç»Ÿ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
        }

       .header {
            display: flex;
            align-items: center;
            padding: 15px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }

       .back-arrow {
            font-size: 24px;
            margin-right: 20px;
            cursor: pointer;
        }

       .deadline-container {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 10px;
        }

       .question-creator {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }

       .question-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            position: relative;
        }

       .type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

       .type-item {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #007bff;
        }

       .type-item.active {
            background: #007bff;
            color: white;
        }

       .option-list {
            margin: 15px 0;
            counter-reset: option-counter;
        }

       .option-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            position: relative;
        }

       .option-item::before {
            counter-increment: option-counter;
            content: counter(option-counter, upper-alpha);
            width: 24px;
            text-align: center;
            margin-right: 10px;
            font-weight: bold;
            color: #666;
        }

       .add-option-btn {
            margin-top: 10px;
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        #createQuestionBtn {
            width: 100%;
            padding: 12px;
            background: #17a2b8;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 20px 0;
        }

       .answer-box {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
        }

       .fixed-bottom-btn {
            position: sticky;
            bottom: 20px;
            z-index: 100;
        }

       .action-buttons {
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

       .action-btn {
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            color: white;
            border: none;
            transition: opacity 0.3s;
        }

       .action-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

       .header {
            display: flex;
            align-items: center;
            padding: 15px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            gap: 30px;
            flex-wrap: wrap;
        }

       .title-input {
            flex: 1;
            min-width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

       .delete-question-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        /* æ–°å¢åˆ†æ•°è¾“å…¥ç›¸å…³æ ·å¼ */
        .score-container {
            position: absolute;
            top: 10px;
            right: 100px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .score-input {
            width: 60px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }

        .score-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>

<body>
    <div class="header">
        <div class="back-arrow" onclick="history.back()">â†</div>
        <input type="text"
            id="assignmentTitle"
            class="title-input"
            placeholder="è¯·è¾“å…¥ä½œä¸šæ ‡é¢˜"
            required>
        <div class="deadline-container">
            <label>æˆªæ­¢æ—¶é—´ï¼š</label>
            <input type="datetime-local"
                id="deadline"
                required
                style="padding: 8px; border-radius: 4px;">
        </div>
    </div>
    <div class="question-creator">
        <div id="questionsContainer">
            <!-- åˆå§‹æ·»åŠ æŒ‰é’® -->
            <button id="createQuestionBtn" class="fixed-bottom-btn" onclick="createNewQuestion()">ï¼‹ æ·»åŠ æ–°é¢˜ç›®</button>
        </div>

        <div class="action-buttons">
            <button class="action-btn" style="background: #6c757d" onclick="handleSave()" id="saveBtn">ğŸ’¾ ä¿å­˜è‰ç¨¿</button>
            <button class="action-btn" id="generateBtn" onclick="handleGenerateAnswers()">âœ¨ ç”Ÿæˆç­”æ¡ˆ</button>
            <button class="action-btn" style="background: #28a745" onclick="handlePublish()" id="publishBtn">ğŸš€ å‘å¸ƒä½œä¸š</button>
        </div>
    </div>

    <script>
        let questionCounter = 0;
        let isSubmitting = false;

        // åˆ›å»ºæ–°é¢˜ç›®
        function createNewQuestion() {
            questionCounter++;
            const questionId = `question_${questionCounter}`;

            const questionCard = document.createElement('div');
            questionCard.className = 'question-card';
            questionCard.innerHTML = `
                <div class="score-container">
                    <span class="score-label">åˆ†å€¼ï¼š</span>
                    <input type="number" 
                           class="score-input"
                           min="0" 
                           max="100"
                           value="10"
                           required>
                </div>
                <button class="delete-question-btn" onclick="deleteQuestion(this)">åˆ é™¤é¢˜ç›®</button>
                <div class="type-selector">
                    <div class="type-item active" data-type="single" onclick="changeType(this, 'single')">
                        <div class="type-dot"></div>
                        å•é€‰é¢˜
                    </div>
                    <div class="type-item" data-type="multiple" onclick="changeType(this, 'multiple')">
                        <div class="type-dot"></div>
                        å¤šé€‰é¢˜
                    </div>
                    <div class="type-item" data-type="blank" onclick="changeType(this, 'blank')">
                        <div class="type-dot"></div>
                        å¡«ç©ºé¢˜
                    </div>
                </div>

                <textarea class="question-content"
                    placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹..."
                    required
                    style="width: 100%; height: 100px; padding: 10px;"></textarea>

                <div class="option-list">
                    ${createDefaultOptions('single')}
                </div>

                <button class="add-option-btn" onclick="addOption(this)">ï¼‹ æ·»åŠ é€‰é¡¹</button>

                <div class="answer-box">
                    <label>æ­£ç¡®ç­”æ¡ˆï¼š</label>
                    <input type="text"
                        class="answer-input"
                        placeholder="${getAnswerPlaceholder('single')}"
                        style="width: 100%; padding: 8px;">
                </div>
            `;

            // å°†æ–°é¢˜ç›®æ’å…¥åˆ°æ·»åŠ æŒ‰é’®ä¹‹å‰
            const container = document.getElementById('questionsContainer');
            const addButton = document.getElementById('createQuestionBtn');
            container.insertBefore(questionCard, addButton);
        }

        async function handleGenerateAnswers() {
            if (isSubmitting) return;
            isSubmitting = true;

            // éªŒè¯é¢˜ç›®å®Œæ•´æ€§
            if (!validateForGeneration()) {
                isSubmitting = false;
                return;
            }

            // æ”¶é›†é¢˜ç›®æ•°æ®
            const questionsData = collectData('save');
            
            try {
                // å‘é€ç”Ÿæˆè¯·æ±‚
                const response = await fetch('/homework/GenerateAnswers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({questionsData:questionsData})
                });

                if (!response.ok) throw new Error('ç”Ÿæˆå¤±è´¥');
                const answers = await response.json();

                // å¡«å……ç­”æ¡ˆ
                if (answers['code'] == 200){
                  fillAnswers(answers['answers']);
                  alert('ç­”æ¡ˆç”ŸæˆæˆåŠŸï¼');
                }
                else{
                  alert('ç­”æ¡ˆç”Ÿæˆå¤±è´¥ï¼');
                }
            } catch (error) {
                console.error('ç”Ÿæˆå¤±è´¥:', error);
                alert('ç­”æ¡ˆç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
            }

            isSubmitting = false;
        }

        function fillAnswers(answers) {
            document.querySelectorAll('.question-card').forEach((card, index) => {
                const type = card.querySelector('.active').dataset.type;
                const answerInput = card.querySelector('.answer-input');
                
                if (answers[index]) {
                    answerInput.value = type === 'multiple' 
                        ? answers[index].join(',') 
                        : answers[index];
                }
            });
        }

        function validateForGeneration() {
            let isValid = true;
            document.querySelectorAll('.question-card').forEach((card, index) => {
                // éªŒè¯é¢˜ç›®å†…å®¹
                if (!card.querySelector('.question-content').value.trim()) {
                    alert(`ç¬¬ ${index + 1} é¢˜æœªå¡«å†™é¢˜ç›®å†…å®¹`);
                    isValid = false;
                }

                // éªŒè¯é€‰æ‹©é¢˜é€‰é¡¹
                if (!card.querySelector('.active').dataset.type.includes('blank')) {
                    card.querySelectorAll('.option-item input').forEach((input, optIndex) => {
                        if (!input.value.trim()) {
                            alert(`ç¬¬ ${index + 1} é¢˜çš„ç¬¬ ${String.fromCharCode(65 + optIndex)} é€‰é¡¹æœªå¡«å†™`);
                            isValid = false;
                        }
                    });
                }
            });
            return isValid;
        }

        // åˆ é™¤é¢˜ç›®
        function deleteQuestion(button) {
            const questionCard = button.closest('.question-card');
            questionCard.remove();
        }

        // è·å–ç­”æ¡ˆè¾“å…¥æç¤º
        function getAnswerPlaceholder(type) {
            const placeholders = {
                single: "è¾“å…¥å•é€‰ç­”æ¡ˆï¼ˆå¦‚ï¼šAï¼‰",
                multiple: "è¾“å…¥å¤šé€‰ç­”æ¡ˆï¼ˆå¦‚ï¼šA,Bï¼‰",
                blank: "è¾“å…¥å¡«ç©ºç­”æ¡ˆï¼ˆå¤šä¸ªç­”æ¡ˆç”¨é€—å·åˆ†éš”ï¼‰"
            };
            return placeholders[type] || "è¾“å…¥ç­”æ¡ˆ";
        }

        // åˆ‡æ¢é¢˜ç›®ç±»å‹
        function changeType(element, type) {
            const card = element.closest('.question-card');
            card.querySelectorAll('.type-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');

            const optionList = card.querySelector('.option-list');
            const addBtn = card.querySelector('.add-option-btn');
            const answerInput = card.querySelector('.answer-input');

            if (type === 'blank') {
                optionList.style.display = 'none';
                addBtn.style.display = 'none';
                answerInput.placeholder = getAnswerPlaceholder('blank');
            } else {
                optionList.style.display = 'block';
                addBtn.style.display = 'block';
                answerInput.placeholder = getAnswerPlaceholder(type);
            }
        }

        // åˆ›å»ºé»˜è®¤é€‰é¡¹
        function createDefaultOptions(type) {
            const letters = ['A', 'B', 'C', 'D'];
            return letters.map(letter => `
                <div class="option-item">
                    <input type="text"
                        placeholder="é€‰é¡¹ ${letter}"
                        required
                        style="flex:1; padding:8px;">
                    <button onclick="this.parentElement.remove()"
                        style="margin-left:10px; color:#dc3545">åˆ é™¤</button>
                </div>
            `).join('');
        }

        // æ·»åŠ é€‰é¡¹
        function addOption(button) {
            const optionList = button.previousElementSibling;
            const newOption = document.createElement('div');
            newOption.className = 'option-item';
            newOption.innerHTML = `
                <input type="text"
                    placeholder="é€‰é¡¹å†…å®¹"
                    required
                    style="flex:1; padding:8px;">
                <button onclick="this.parentElement.remove()"
                    style="margin-left:10px; color:#dc3545">åˆ é™¤</button>
            `;
            optionList.appendChild(newOption);
        }

        function validateFormData(data) {
            // éªŒè¯ä½œä¸šæ ‡é¢˜
            if (!data.title) {
                alert('è¯·å¡«å†™ä½œä¸šæ ‡é¢˜');
                document.getElementById('assignmentTitle').focus();
                return false;
            }

            // éªŒè¯æˆªæ­¢æ—¶é—´
            if (!data.deadline) {
                alert('è¯·è®¾ç½®æˆªæ­¢æ—¶é—´');
                document.getElementById('deadline').focus();
                return false;
            }

            // åŸæœ‰é¢˜ç›®éªŒè¯
            if (data.questions.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªé¢˜ç›®');
                return false;
            }

            for (const [index, question] of data.questions.entries()) {
                if (!question.content.trim()) {
                    alert(`ç¬¬ ${index + 1} é¢˜æœªå¡«å†™é¢˜ç›®å†…å®¹`);
                    return false;
                }

                if (question.type !== 'blank' && question.options.length < 2) {
                    alert(`ç¬¬ ${index + 1} é¢˜éœ€è¦è‡³å°‘ä¸¤ä¸ªé€‰é¡¹`);
                    return false;
                }

                // æ–°å¢ç­”æ¡ˆéªŒè¯ï¼ˆæ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†ï¼‰
                if (!question.answer.trim()) {
                    alert(`ç¬¬ ${index + 1} é¢˜æœªå¡«å†™ç­”æ¡ˆ`);
                    // èšç„¦åˆ°å¯¹åº”çš„ç­”æ¡ˆè¾“å…¥æ¡†
                    document.querySelectorAll('.answer-input')[index].focus();
                    return false;
                }

                // å¯é€‰ï¼šéªŒè¯é€‰æ‹©é¢˜ç­”æ¡ˆæ ¼å¼
                if (question.type !== 'blank') {
                    const validOptions = question.options.map((_, i) => String.fromCharCode(65 + i));
                    const answers = question.answer.toUpperCase().split(',');
                    
                    if (answers.some(a => !validOptions.includes(a))) {
                        alert(`ç¬¬ ${index + 1} é¢˜ç­”æ¡ˆåŒ…å«æ— æ•ˆé€‰é¡¹`);
                        document.querySelectorAll('.answer-input')[index].focus();
                        return false;
                    }
                }
            }
            // æ–°å¢åˆ†æ•°éªŒè¯
            for (const [index, question] of data.questions.entries()) {
                if (question.sumscore < 0 || question.sumscore > 100) {
                    alert(`ç¬¬ ${index + 1} é¢˜åˆ†æ•°å€¼æ— æ•ˆï¼ˆ0-100ï¼‰`);
                    document.querySelectorAll('.score-input')[index].focus();
                    return false;
                }
            }
            return true;
        }

        // ä¿®æ”¹åçš„æ•°æ®æ”¶é›†
        function collectData(actionType) {
            const questions = [];
            document.querySelectorAll('.question-card').forEach(card => {
                const type = card.querySelector('.active').dataset.type;
                const question = {
                    type: type,
                    content: card.querySelector('.question-content').value.trim(),
                    sumscore: parseInt(card.querySelector('.score-input').value) || 10, // æ–°å¢åˆ†æ•°å­—æ®µ
                    options: [],
                    answer: card.querySelector('.answer-input').value.trim()
                };

                if (type !== 'blank') {
                    card.querySelectorAll('.option-item input').forEach(opt => {
                        question.options.push(opt.value.trim());
                    });
                }

                questions.push(question);
            });

            return {
                title: document.getElementById('assignmentTitle').value.trim(),
                deadline: document.getElementById('deadline').value,
                questions: questions,
                action: actionType // 'save' æˆ– 'publish'
            };
        }

        // æäº¤æ•°æ®ç¤ºä¾‹ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        async function sendDataToBackend(data) {
            console.log('æäº¤æ•°æ®ï¼š', data);
            // å®é™…è¯·æ±‚éœ€è¦æ ¹æ®åç«¯APIè°ƒæ•´
            try {
                const response = await fetch('/homeworks/savehomework', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ homework: data })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                alert(data.action === 'save' ? 'ä¿å­˜æˆåŠŸï¼' : 'å‘å¸ƒæˆåŠŸï¼');
                window.location.href = '/';
            } catch (error) {
                console.error('æäº¤å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }

        // ä¿®æ”¹åçš„å¤„ç†å‡½æ•°
        async function handleSave() {
            if (isSubmitting) return;
            isSubmitting = true;

            const formData = collectData('save');
            if (validateFormData(formData)) {
                await sendDataToBackend(formData);
            }
            isSubmitting = false;
        }

        async function handlePublish() {
            if (isSubmitting) return;
            isSubmitting = true;

            const formData = collectData('publish');
            if (validateFormData(formData)) {
                await sendDataToBackend(formData);
            }
            isSubmitting = false;
        }
    </script>
</body>

</html>    
